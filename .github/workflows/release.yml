name: Release
# This workflow builds and releases Vesta Launcher
# - Fails fast: if any build fails, the entire release is cancelled
# - Concurrency: cancels in-progress runs when new ones start
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true
on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        type: choice
        default: 'none'
        options:
          - none
          - patch
          - minor
          - major
          - alpha
          - beta
      build_windows:
        description: 'Windows (x64 & ARM64)'
        type: boolean
        default: true
      build_macos:
        description: 'macOS (x64 & ARM64)'
        type: boolean
        default: true
      build_linux:
        description: 'Linux (x64 & ARM64)'
        type: boolean
        default: true
  push:
    tags:
      - 'v*'

jobs:
  bump-version:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.bump != 'none'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: oven-sh/setup-bun@v1
      - id: bump
        run: |
          bun run version:bump ${{ github.event.inputs.bump }}
          AFTER=$(node -e "console.log(require('./vesta-launcher/src-tauri/tauri.conf.json').version)")
          if [ "$AFTER" = "" ]; then
            echo "Error: Version bump failed - no version found after bump"
            exit 1
          fi
          echo "version=$AFTER" >> $GITHUB_OUTPUT
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: bump version to $AFTER"
          git push
          git tag "v$AFTER"
          git push --tags

  build:
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped')
    permissions:
      contents: write
    strategy:
      fail-fast: true
      matrix:
        include:
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            enabled: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_windows == 'true') }}
            name: 'Windows x64'
            target: 'x86_64-pc-windows-msvc'
          - platform: 'windows-latest'
            args: '--target aarch64-pc-windows-msvc'
            enabled: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_windows == 'true') }}
            name: 'Windows ARM64'
            target: 'aarch64-pc-windows-msvc'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            enabled: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_macos == 'true') }}
            name: 'macOS x64'
            target: 'x86_64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            enabled: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_macos == 'true') }}
            name: 'macOS ARM64'
            target: 'aarch64-apple-darwin'
          - platform: 'ubuntu-latest'
            args: '--target x86_64-unknown-linux-gnu'
            enabled: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_linux == 'true') }}
            name: 'Linux x64'
            target: 'x86_64-unknown-linux-gnu'
          - platform: 'ubuntu-latest'
            args: '--target aarch64-unknown-linux-gnu'
            enabled: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_linux == 'true') }}
            name: 'Linux ARM64'
            target: 'aarch64-unknown-linux-gnu'
    
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Determine checkout ref
        id: ref
        run: |
          if [ "${{ needs.bump-version.result }}" = "success" ]; then
            REF="refs/tags/v${{ needs.bump-version.outputs.new_version }}"
          else
            REF="${{ github.ref }}"
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
      
      - uses: actions/checkout@v4
        if: matrix.enabled
        with:
          ref: ${{ steps.ref.outputs.ref }}
          fetch-depth: 0

      - name: Install dependencies (Linux only)
        if: matrix.enabled && matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev
          # Cross-compilation tools for ARM64
          sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      - name: Setup Node.js
        if: matrix.enabled
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Bun
        if: matrix.enabled
        uses: oven-sh/setup-bun@v1

      - name: Setup Rust
        if: matrix.enabled
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        if: matrix.enabled
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            vesta-launcher/src-tauri -> target
            crates/piston-lib -> target
          cache-all-crates: true

      - name: Install frontend dependencies
        if: matrix.enabled
        run: bun install

      - name: Build Tauri App
        if: matrix.enabled
        run: |
          cd vesta-launcher
          if [ "${{ matrix.platform }}" == "macos-latest" ]; then
            bun run tauri build --target ${{ matrix.target }} --bundles dmg
          elif [ "${{ matrix.platform }}" == "ubuntu-latest" ]; then
            bun run tauri build --target ${{ matrix.target }} --bundles deb
          else
            bun run tauri build --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Upload to Cloudflare R2
        if: matrix.enabled
        shell: bash
        run: |
          # Configure AWS for R2
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set region auto
          
          VERSION=$(node -e "console.log(require('./vesta-launcher/src-tauri/tauri.conf.json').version)")
          
          # Upload and rename to canonical format
          find target/${{ matrix.target }}/release/bundle/ -type f \( -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" \) -print0 | while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            ext="${filename##*.}"
            
            target_name=""
            case "$ext" in
              msi)
                if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
                  target_name="Vesta_Launcher_${VERSION}_arm64.msi"
                else
                  target_name="Vesta_Launcher_${VERSION}_x64.msi"
                fi
                ;;
              dmg)
                if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
                  target_name="Vesta_Launcher_${VERSION}_aarch64.dmg"
                else
                  target_name="Vesta_Launcher_${VERSION}_x64.dmg"
                fi
                ;;
              deb)
                if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
                  target_name="vesta-launcher_${VERSION}_arm64.deb"
                else
                  target_name="vesta-launcher_${VERSION}_amd64.deb"
                fi
                ;;
              AppImage)
                target_name="Vesta_Launcher_${VERSION}_x86_64.AppImage"
                ;;
            esac
            
            if [ -n "$target_name" ]; then
              echo "Uploading $filename as $target_name"
              aws s3 cp "$file" "s3://vesta-project/launcher/releases/$target_name" --endpoint-url https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com
            else
              echo "Uploading $filename"
              aws s3 cp "$file" s3://vesta-project/launcher/releases/ --endpoint-url https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com
            fi
          done

      - name: Upload build artifacts
        if: matrix.enabled
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.name }}
          path: |
            target/${{ matrix.target }}/release/bundle/*.msi
            target/${{ matrix.target }}/release/bundle/*.dmg
            target/${{ matrix.target }}/release/bundle/*.deb
            target/${{ matrix.target }}/release/bundle/*.AppImage

  generate-manifest:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate R2 secrets
        run: |
          if [ -z "${{ secrets.R2_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.R2_SECRET_ACCESS_KEY }}" ]; then
            echo "R2 secrets not configured, skipping manifest generation"
            exit 0
          fi
      - name: Configure AWS for R2
        run: |
          aws configure set aws_access_key_id ${{ secrets.R2_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws configure set region auto
      - name: Generate and upload latest.json
        run: |
          VERSION=$(node -e "console.log(require('./vesta-launcher/src-tauri/tauri.conf.json').version)")
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          NOTES="Automatic release"
          
          cat > latest.json << EOF
          {
            "version": "$VERSION",
            "notes": "$NOTES",
            "pub_date": "$PUB_DATE",
            "platforms": {
              "windows-x86_64": {
                "url": "https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com/vesta-project/launcher/releases/Vesta_Launcher_${VERSION}_x64.msi",
                "signature": ""
              },
              "windows-aarch64": {
                "url": "https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com/vesta-project/launcher/releases/Vesta_Launcher_${VERSION}_arm64.msi",
                "signature": ""
              },
              "darwin-x86_64": {
                "url": "https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com/vesta-project/launcher/releases/Vesta_Launcher_${VERSION}_x64.dmg",
                "signature": ""
              },
              "darwin-aarch64": {
                "url": "https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com/vesta-project/launcher/releases/Vesta_Launcher_${VERSION}_aarch64.dmg",
                "signature": ""
              },
              "linux-x86_64": {
                "url": "https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com/vesta-project/launcher/releases/vesta-launcher_${VERSION}_amd64.deb",
                "signature": ""
              },
              "linux-aarch64": {
                "url": "https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com/vesta-project/launcher/releases/vesta-launcher_${VERSION}_arm64.deb",
                "signature": ""
              }
            }
          }
          EOF
          
          aws s3 cp latest.json s3://vesta-project/launcher/releases/ --endpoint-url https://b30108be91a7d16a9ae5d6c87838cec0.r2.cloudflarestorage.com

  create-github-release:
    needs: [build, generate-manifest]
    if: needs.build.result == 'success' && (needs.bump-version.result == 'success' || github.event_name == 'push')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ needs.bump-version.result }}" = "success" ]; then
            # Version bump was performed
            VERSION="${{ needs.bump-version.outputs.new_version }}"
          else
            # Tag push - extract version from tag
            VERSION="${{ github.ref_name }}"
            # Remove 'v' prefix if present
            VERSION="${VERSION#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: List downloaded artifacts
        run: find artifacts/ -type f -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" | sort
      
      - name: Validate artifacts
        run: |
          ARTIFACT_COUNT=$(find artifacts/ -type f \( -name "*.msi" -o -name "*.dmg" -o -name "*.deb" -o -name "*.AppImage" \) | wc -l)
          if [ "$ARTIFACT_COUNT" -lt 3 ]; then
            echo "Error: Expected at least 3 build artifacts, found $ARTIFACT_COUNT"
            echo "This likely means some builds failed. Check the build job logs."
            exit 1
          fi
          echo "Found $ARTIFACT_COUNT build artifacts - proceeding with release"
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get the current tag
          CURRENT_TAG="v${{ steps.version.outputs.version }}"
          
          # Get the previous tag (if it exists)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          echo "## Changelog" > changelog.md
          echo "" >> changelog.md
          
          if [ -n "$PREVIOUS_TAG" ] && [ "$PREVIOUS_TAG" != "$CURRENT_TAG" ]; then
            # Check if the range has commits
            if git rev-list --count ${PREVIOUS_TAG}..${CURRENT_TAG} >/dev/null 2>&1; then
              git log --pretty=format:"- %s (%h)" --no-merges ${PREVIOUS_TAG}..${CURRENT_TAG} >> changelog.md 2>/dev/null || echo "- Release notes" >> changelog.md
            else
              echo "- Release notes" >> changelog.md
            fi
          else
            echo "- Initial release or patch update" >> changelog.md
          fi
          
          # Escape newlines for GitHub Actions output
          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Vesta Launcher v${{ steps.version.outputs.version }}
          body: |
            ## Vesta Launcher v${{ steps.version.outputs.version }}
            
            Automatic release build for Vesta Launcher.
            
            ### Downloads
            All platform installers are attached to this release as assets.
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### CDN Distribution
            This release is also available via CDN for auto-updating launchers.
          files: artifacts/**/*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}